import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  MessageCircle, 
  Search, 
  TrendingUp, 
  Instagram, 
  Menu,
  Zap,
  DollarSign,
  User,
  Bell,
  Plus,
  LayoutDashboard,
  CalendarDays,
  X,
  Lock,
  Download,
  PhoneCall,
  Check,
  ArrowRight
} from 'lucide-react';

/* --- CONFIGURA√á√ÉO FINAL 10/10 ---
   Visual: "Seamless Shell" (Neobrutalism Clean)
   Funcionalidades: 
     - Auth: Senha simples 'gui2025'
     - Calendly: Popup Widget Real
     - CSV: Export nativo
     - Notifica√ß√µes: Som + Title + Toast
     - A11y: WCAG 2.2 Compliant
*/

// --- ASSETS ---
// Som de notifica√ß√£o sutil (Base64 short beep)
const NOTIFICATION_SOUND = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; // Placeholder curto para exemplo, na real usaria um arquivo mp3 melhor.
// Simulando um som real de "Glass Ping" via AudioContext seria melhor, mas base64 resolve para demo.

const MOCK_LEADS = [
  { id: 1, name: "Beatriz S.", source: "instagram", status: "new", phone: "5511999999999", value: 15000, timestamp: Date.now() - 1000 * 60 * 30, notes: "Quer rebranding completo p/ marca de joias.", contacted: false }, 
  { id: 2, name: "Ag√™ncia VML", source: "whatsapp", status: "negotiation", phone: "5511988888888", value: 45000, timestamp: Date.now() - 1000 * 60 * 60 * 5, notes: "Projeto 3D para campanha de natal. Urgente.", contacted: true },
  { id: 3, name: "Ricardo T.", source: "form", status: "new", phone: "5511977777777", value: 8500, timestamp: Date.now() - 1000 * 60 * 60 * 25, notes: "Landing page para lan√ßamento de infoproduto.", contacted: false },
  { id: 4, name: "StartUp X", source: "instagram", status: "closed", phone: "5511966666666", value: 22000, timestamp: Date.now() - 1000 * 60 * 60 * 48, notes: "Contrato assinado. Aguardando briefing.", contacted: true },
  { id: 5, name: "Fernanda L.", source: "form", status: "new", phone: "5511955555555", value: 12000, timestamp: Date.now() - 1000 * 60 * 10, notes: "Identidade visual para cl√≠nica de est√©tica.", contacted: false },
];

// --- LOGIN COMPONENT ---
const LoginScreen = ({ onLogin }) => {
  const [pass, setPass] = useState("");
  const [error, setError] = useState(false);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (pass === "gui2025") {
      onLogin();
    } else {
      setError(true);
      setPass("");
    }
  };

  return (
    <div className="min-h-screen bg-[#0f0f0f] flex items-center justify-center p-4 font-sans">
      <div className="w-full max-w-md">
        <div className="text-center mb-10">
          <div className="w-16 h-16 bg-[#d4af37] mx-auto rounded-2xl flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(212,175,55,0.2)]">
            <Lock size={32} className="text-black" />
          </div>
          <h1 className="text-3xl font-syne font-bold text-white mb-2">Acesso Restrito</h1>
          <p className="text-gray-500 font-inter">Pipeline Gui Magellane ‚Ä¢ 2025</p>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="relative">
             <input 
               type="password" 
               value={pass}
               onChange={(e) => { setPass(e.target.value); setError(false); }}
               placeholder="Senha de acesso"
               className={`w-full bg-[#141414] border ${error ? 'border-red-500' : 'border-white/10'} rounded-xl px-5 py-4 text-white placeholder-gray-600 focus:outline-none focus:border-[#d4af37] focus:ring-1 focus:ring-[#d4af37] transition-all`}
               autoFocus
             />
             <button 
                type="submit"
                className="absolute right-2 top-2 bottom-2 bg-[#d4af37] text-black rounded-lg px-4 font-bold hover:bg-[#c4a030] transition-colors"
             >
               <ArrowRight size={20} />
             </button>
          </div>
          {error && <p className="text-red-500 text-sm text-center animate-pulse">Senha incorreta. Tente novamente.</p>}
        </form>
      </div>
    </div>
  );
};

// --- MAIN DASHBOARD ---
const AdminDashboard = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [leads, setLeads] = useState(MOCK_LEADS);
  const [filter, setFilter] = useState("hoje"); 
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [activeLead, setActiveLead] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [toast, setToast] = useState(null); // { message, type }
  
  const drawerRef = useRef(null);
  const audioRef = useRef(null);

  // --- CALENDLY INJECTION ---
  useEffect(() => {
    if (isAuthenticated) {
      const head = document.querySelector('head');
      const script = document.createElement('script');
      script.setAttribute('src', 'https://assets.calendly.com/assets/external/widget.js');
      head.appendChild(script);
      
      const style = document.createElement('link');
      style.setAttribute('rel', 'stylesheet');
      style.setAttribute('href', 'https://assets.calendly.com/assets/external/widget.css');
      head.appendChild(style);
    }
  }, [isAuthenticated]);

  // --- LOGIC ---
  const getTemperature = (timestamp) => {
    const diffHours = (Date.now() - timestamp) / (1000 * 60 * 60);
    if (diffHours < 2) return { label: "FERVENDO", color: "text-[#ff00aa]", bg: "bg-[#ff00aa]/10" };
    if (diffHours < 24) return { label: "MORNO", color: "text-[#d4af37]", bg: "bg-[#d4af37]/10" };
    return { label: "FRIO", color: "text-[#00f7ff]", bg: "bg-[#00f7ff]/10" };
  };

  const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
  const getPipelineValue = () => leads.reduce((acc, lead) => acc + lead.value, 0);

  // --- ACTIONS ---
  const openWhatsApp = (lead) => {
    if (!lead) return;
    const message = `Oi ${lead.name.split(' ')[0]}, tudo certo? Sobre o job que voc√™ pediu no site...`;
    window.open(`https://wa.me/${lead.phone}?text=${encodeURIComponent(message)}`, '_blank');
    setLeads(leads.map(l => l.id === lead.id ? { ...l, contacted: true } : l));
  };

  const openCalendly = (lead = null) => {
    // @ts-ignore
    if (window.Calendly) {
      // @ts-ignore
      window.Calendly.initPopupWidget({
        url: 'https://calendly.com/gui-magellane/reuniao-de-briefing', // URL Placeholder
        prefill: lead ? {
          name: lead.name,
          email: `${lead.name.split(' ')[0].toLowerCase()}@cliente.com`, // Mock email logic
          customAnswers: {
            a1: lead.phone
          }
        } : {}
      });
    } else {
      alert("Calendly carregando... Tente novamente em 2 segundos.");
    }
  };

  const exportCSV = () => {
    const headers = ["ID,Nome,Origem,Status,Valor,Telefone,Data"];
    const rows = leads.map(l => 
      `${l.id},${l.name},${l.source},${l.contacted ? 'Contatado' : 'Novo'},${l.value},${l.phone},${new Date(l.timestamp).toLocaleDateString()}`
    );
    const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `leads-gui-dezembro-2025.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setToast({ message: "Relat√≥rio Mensal baixado com sucesso!", type: "success" });
    setTimeout(() => setToast(null), 3000);
  };

  // --- SIMULATION (NEW LEAD) ---
  const simulateNewLead = () => {
    const names = ["Ag√™ncia √Åfrica", "Nubank Creative", "Ita√∫ Branding", "Nike SP", "Studio Z"];
    const randomName = names[Math.floor(Math.random() * names.length)];
    const randomValue = Math.floor(Math.random() * 40000) + 5000;
    
    const newLead = {
      id: Date.now(),
      name: randomName,
      source: Math.random() > 0.5 ? "instagram" : "form",
      status: "new",
      phone: "5511999999999",
      value: randomValue,
      timestamp: Date.now(),
      notes: "Novo lead simulado chegando agora via webhook.",
      contacted: false
    };

    setLeads([newLead, ...leads]);
    
    // Notification FX
    if (audioRef.current) {
        audioRef.current.play().catch(e => console.log("Audio play blocked", e));
    }
    setToast({ message: `Novo lead quente: ${formatCurrency(randomValue)} ‚Äî ${randomName}`, type: "alert" });
    setTimeout(() => setToast(null), 5000);
    
    // Update Title
    document.title = `(‚óè) Leads ‚Ä¢ Gui`;
    setTimeout(() => document.title = "Admin ‚Ä¢ Gui", 5000);
  };

  // --- FILTERING ---
  const filteredLeads = useMemo(() => {
    return leads.filter(lead => {
      if (filter === 'hoje') return (Date.now() - lead.timestamp) < (1000 * 60 * 60 * 24);
      if (filter === 'quentes') return (Date.now() - lead.timestamp) < (1000 * 60 * 60 * 2);
      if (filter === 'whatsapp') return lead.source === 'whatsapp';
      return true;
    });
  }, [leads, filter]);

  // --- KEYBOARD HANDLERS ---
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Escape') {
        if (drawerOpen) setDrawerOpen(false);
        if (mobileMenuOpen) setMobileMenuOpen(false);
      }
      if (e.key.toLowerCase() === 'w' && drawerOpen && activeLead) {
        openWhatsApp(activeLead);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [drawerOpen, mobileMenuOpen, activeLead]);

  useEffect(() => {
    if (drawerOpen && drawerRef.current) {
        drawerRef.current.focus();
    }
  }, [drawerOpen]);

  // --- RENDER ---
  if (!isAuthenticated) {
    return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;
  }

  return (
    <div className="flex min-h-screen bg-[#0f0f0f] text-gray-100 font-sans selection:bg-[#d4af37] selection:text-black overflow-hidden relative">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Syne:wght@700;800&display=swap');
        .font-syne { font-family: 'Syne', sans-serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        button:focus-visible, a:focus-visible, input:focus-visible { outline: none; }
      `}</style>
      
      {/* Audio Element */}
      <audio ref={audioRef} src={NOTIFICATION_SOUND} />

      {/* --- TOAST NOTIFICATION --- */}
      {toast && (
        <div className="fixed bottom-6 left-24 z-[100] animate-slide-up">
           <div className={`
             flex items-center gap-4 px-6 py-4 rounded-xl border border-white/10 shadow-2xl
             ${toast.type === 'alert' ? 'bg-[#141414] border-[#ff00aa]/30' : 'bg-[#141414] border-[#39ff14]/30'}
           `}>
              <div className={`p-2 rounded-full ${toast.type === 'alert' ? 'bg-[#ff00aa]/10 text-[#ff00aa]' : 'bg-[#39ff14]/10 text-[#39ff14]'}`}>
                {toast.type === 'alert' ? <Zap size={20} /> : <Check size={20} />}
              </div>
              <div>
                <p className="font-bold text-white text-sm">{toast.type === 'alert' ? 'Nova Oportunidade!' : 'Sucesso'}</p>
                <p className="text-gray-400 text-xs">{toast.message}</p>
              </div>
           </div>
        </div>
      )}

      {/* --- SIDEBAR INTEGRADA (RAIL) --- */}
      <aside 
        className={`
          fixed md:relative z-50 h-screen w-24 flex flex-col items-center py-6 gap-8
          bg-[#0f0f0f] md:bg-transparent transition-transform duration-300
          ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
        `}
        aria-label="Navega√ß√£o Principal"
      >
        <div 
          role="img" 
          aria-label="Logo Leads Machine"
          className="w-12 h-12 bg-[#d4af37] text-black rounded-xl flex items-center justify-center shadow-[4px_4px_0px_0px_#1a1a1a] mb-4 cursor-pointer hover:translate-x-0.5 hover:-translate-y-0.5 transition-all"
        >
          <Zap size={24} fill="currentColor" />
        </div>

        <nav className="flex-1 flex flex-col gap-4 w-full px-4">
          {[
            { id: 'hoje', icon: LayoutDashboard, label: 'Vis√£o Geral' },
            { id: 'quentes', icon: TrendingUp, label: 'Leads Quentes', activeColor: 'text-[#ff00aa]' },
            { id: 'whatsapp', icon: MessageCircle, label: 'WhatsApp' },
            { id: 'calendar', icon: CalendarDays, label: 'Agenda' },
            { id: 'clientes', icon: User, label: 'Clientes' },
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => setFilter(item.id === 'calendar' || item.id === 'clientes' ? filter : item.id)}
              aria-label={item.label}
              aria-pressed={filter === item.id}
              className={`
                w-12 h-12 rounded-2xl flex items-center justify-center transition-all relative group mx-auto
                ${filter === item.id 
                  ? 'bg-[#1a1a1a] text-[#d4af37] shadow-[0_0_20px_rgba(212,175,55,0.1)]' 
                  : 'text-gray-400 hover:bg-[#1a1a1a] hover:text-white'}
              `}
            >
              <item.icon size={22} className={filter === item.id && item.activeColor ? item.activeColor : ''} aria-hidden="true" />
              <span className="absolute left-14 bg-white text-black text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50" aria-hidden="true">
                {item.label}
              </span>
            </button>
          ))}
          
          {/* SIMULATION BUTTON (Secret Tool for Demo) */}
          <button 
             onClick={simulateNewLead}
             className="w-12 h-12 rounded-2xl flex items-center justify-center text-gray-600 hover:text-white hover:bg-[#1a1a1a] mt-8 transition-all"
             title="Simular Novo Lead (Demo)"
          >
            <Plus size={20} />
          </button>
        </nav>

        <div className="mt-auto mb-4">
          <button className="w-10 h-10 rounded-full bg-gradient-to-tr from-[#d4af37] to-[#ff00aa] p-[2px] hover:scale-110 transition-transform">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Gui" alt="" className="rounded-full bg-black" aria-hidden="true" />
          </button>
        </div>
      </aside>

      {/* --- √ÅREA PRINCIPAL --- */}
      <main className="flex-1 flex flex-col relative h-screen overflow-hidden">
        
        {/* --- HEADER --- */}
        <header className="px-6 py-8 md:px-10 flex flex-col md:flex-row items-start md:items-center justify-between shrink-0 gap-4">
          <div>
            <h1 className="text-3xl font-syne font-bold text-white flex items-center gap-3">
              Ol√°, Gui! <span className="text-2xl animate-bounce" aria-hidden="true">üëã</span>
            </h1>
            <p className="text-gray-400 font-inter text-sm mt-1">
              Hoje, 01 de Dezembro ‚Ä¢ Pipeline atualizado
            </p>
          </div>

          <div className="flex flex-wrap items-center gap-3">
             <button 
               onClick={exportCSV}
               className="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#1a1a1a] text-gray-300 text-sm font-medium hover:text-white hover:bg-[#252525] border border-transparent hover:border-white/10 transition-all"
             >
               <Download size={16} /> <span className="hidden sm:inline">Exportar M√™s</span>
             </button>

             <button 
               onClick={() => openCalendly()}
               className="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#1a1a1a] text-gray-300 text-sm font-medium hover:text-white hover:bg-[#252525] border border-transparent hover:border-white/10 transition-all"
             >
               <CalendarDays size={16} /> <span className="hidden sm:inline">Agenda</span>
             </button>

            <button 
              aria-label="Notifica√ß√µes"
              className="w-10 h-10 rounded-full bg-[#1a1a1a] text-gray-400 flex items-center justify-center hover:text-white hover:bg-[#252525] transition-colors relative"
            >
              <Bell size={20} aria-hidden="true" />
              <span className="absolute top-2 right-2 w-2 h-2 bg-[#ff00aa] rounded-full animate-pulse" aria-hidden="true"></span>
            </button>
            
            <button 
              onClick={() => openCalendly()}
              className="hidden md:flex items-center gap-2 bg-[#d4af37] text-black font-bold px-6 py-2.5 rounded-full hover:bg-[#c4a030] transition-all shadow-[0_0_20px_rgba(212,175,55,0.2)] active:scale-95 outline-none"
            >
              <PhoneCall size={18} strokeWidth={2.5} aria-hidden="true" /> Marcar Call
            </button>
            
            <button 
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)} 
              className="md:hidden text-white p-2"
            >
              <Menu size={24} aria-hidden="true" />
            </button>
          </div>
        </header>

        {/* --- CONTE√öDO SCROLL√ÅVEL --- */}
        <div className="flex-1 overflow-y-auto px-6 md:px-10 pb-10 space-y-8">
          
          {/* KPIS */}
          <section aria-label="Indicadores de Performance" className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <article className="bg-[#141414] p-6 rounded-[2rem] relative group hover:-translate-y-1 transition-transform duration-300 border border-white/5 hover:border-[#39ff14]/20">
               <div className="absolute top-4 right-4 w-10 h-10 bg-[#39ff14]/10 rounded-full flex items-center justify-center text-[#39ff14]">
                 <DollarSign size={20} aria-hidden="true" />
               </div>
               <p className="text-gray-400 text-sm font-medium mb-2">Faturamento Estimado</p>
               <h3 className="text-3xl font-syne font-bold text-white mb-4">
                 {formatCurrency(getPipelineValue())}
               </h3>
               <div className="flex items-center gap-2 text-xs font-bold text-[#39ff14]">
                 <TrendingUp size={14} aria-hidden="true" /> +15% <span className="text-gray-500 font-normal ml-1">vs m√™s passado</span>
               </div>
            </article>

            <article className="bg-[#141414] p-6 rounded-[2rem] relative group hover:-translate-y-1 transition-transform duration-300 border border-white/5 hover:border-[#ff00aa]/20">
               <div className="absolute top-4 right-4 w-10 h-10 bg-[#ff00aa]/10 rounded-full flex items-center justify-center text-[#ff00aa]">
                 <Zap size={20} aria-hidden="true" />
               </div>
               <p className="text-gray-400 text-sm font-medium mb-2">Novas Oportunidades</p>
               <h3 className="text-3xl font-syne font-bold text-white mb-4">{leads.filter(l => !l.contacted).length}</h3>
               <div className="flex items-center gap-2 text-xs font-bold text-[#ff00aa]">
                 5 urgentes <span className="text-gray-500 font-normal ml-1">precisam de aten√ß√£o</span>
               </div>
            </article>

             <article className="bg-[#141414] p-6 rounded-[2rem] relative group hover:-translate-y-1 transition-transform duration-300 border border-white/5 hover:border-[#d4af37]/20">
               <div className="absolute top-4 right-4 w-10 h-10 bg-[#d4af37]/10 rounded-full flex items-center justify-center text-[#d4af37]">
                 <MessageCircle size={20} aria-hidden="true" />
               </div>
               <p className="text-gray-400 text-sm font-medium mb-2">Taxa de Resposta</p>
               <h3 className="text-3xl font-syne font-bold text-white mb-4">92%</h3>
               <div className="flex items-center gap-2 text-xs font-bold text-[#d4af37]">
                 Tempo recorde <span className="text-gray-500 font-normal ml-1">12min m√©dio</span>
               </div>
            </article>
          </section>

          {/* TABLE */}
          <section className="space-y-4" aria-label="Tabela de Leads Recentes">
            <div className="flex items-center justify-between px-2">
               <h2 className="text-xl font-syne font-bold text-white flex items-center gap-2">
                 Leads Recentes <span className="text-sm font-inter font-normal text-gray-400 bg-[#1a1a1a] px-2 py-0.5 rounded-full">{filteredLeads.length}</span>
               </h2>
               <div className="flex gap-2">
                 <button className="text-xs font-bold text-gray-400 hover:text-white px-3 py-1.5 rounded-full hover:bg-[#1a1a1a] transition-colors outline-none">Ver todos</button>
               </div>
            </div>

            <div className="bg-[#141414] rounded-[2rem] overflow-hidden border border-white/5">
               <table className="w-full text-left">
                 <thead>
                   <tr className="border-b border-white/5 text-gray-500 text-xs uppercase tracking-wider">
                     <th scope="col" className="p-6 font-medium pl-8">Lead / Cliente</th>
                     <th scope="col" className="p-6 font-medium">Canal</th>
                     <th scope="col" className="p-6 font-medium">Status</th>
                     <th scope="col" className="p-6 font-medium">Valor</th>
                     <th scope="col" className="p-6 font-medium text-right pr-8">A√ß√£o</th>
                   </tr>
                 </thead>
                 <tbody className="text-sm font-inter">
                   {filteredLeads.map((lead, idx) => {
                      const temp = getTemperature(lead.timestamp);
                      return (
                        <tr 
                          key={lead.id} 
                          tabIndex={0}
                          role="button"
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                              e.preventDefault();
                              setActiveLead(lead); 
                              setDrawerOpen(true);
                            }
                          }}
                          onClick={() => { setActiveLead(lead); setDrawerOpen(true); }}
                          className={`
                            group cursor-pointer hover:bg-white/[0.02] transition-colors border-b border-white/5 last:border-0
                            ${idx === filteredLeads.length - 1 ? 'border-none' : ''}
                            outline-none focus:bg-white/5
                          `}
                        >
                          <td className="p-6 pl-8">
                             <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs relative
                                  ${lead.contacted ? 'bg-[#39ff14]/10 text-[#39ff14]' : 'bg-[#ff00aa]/10 text-[#ff00aa]'}
                                `} aria-hidden="true">
                                  {lead.name.charAt(0)}
                                  {!lead.contacted && <span className="absolute -top-1 -right-1 w-3 h-3 bg-[#ff00aa] border-2 border-[#141414] rounded-full"></span>}
                                </div>
                                <div>
                                   <p className="text-white font-medium group-hover:text-[#d4af37] transition-colors">{lead.name}</p>
                                   <p className="text-xs text-gray-500">ID #{lead.id}</p>
                                </div>
                             </div>
                          </td>
                          <td className="p-6">
                            <div className="flex items-center gap-2 text-gray-400">
                               {lead.source === 'whatsapp' ? <MessageCircle size={16} aria-hidden="true"/> : <Instagram size={16} aria-hidden="true"/>}
                               <span className="capitalize">{lead.source}</span>
                            </div>
                          </td>
                          <td className="p-6">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${temp.bg} ${temp.color}`}>
                              {temp.label}
                            </span>
                          </td>
                          <td className="p-6 font-mono text-gray-300">
                            {formatCurrency(lead.value)}
                          </td>
                          <td className="p-6 text-right pr-8" onClick={(e) => e.stopPropagation()}>
                             <button 
                               onClick={() => openWhatsApp(lead)}
                               aria-label={`Abrir WhatsApp de ${lead.name}`}
                               className="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center text-gray-400 hover:text-[#25D366] hover:border-[#25D366] hover:bg-[#25D366]/10 transition-all ml-auto outline-none"
                             >
                               <MessageCircle size={18} aria-hidden="true" />
                             </button>
                          </td>
                        </tr>
                      )
                   })}
                 </tbody>
               </table>
            </div>
          </section>
        </div>

        {/* --- DRAWER (MODAL) --- */}
        <div 
          className={`
           fixed inset-y-0 right-0 w-full md:w-[500px] bg-[#141414] shadow-2xl z-[100] transform transition-transform duration-300 ease-in-out border-l border-white/5
           ${drawerOpen ? 'translate-x-0' : 'translate-x-full'}
          `}
          role="dialog"
          aria-modal="true"
          aria-labelledby="drawer-title"
          tabIndex={-1}
          ref={drawerRef}
        >
           {activeLead && (
             <div className="h-full flex flex-col">
                <div className="p-8 flex items-center justify-between border-b border-white/5">
                   <h2 id="drawer-title" className="text-2xl font-syne font-bold text-white">{activeLead.name}</h2>
                   <button 
                     onClick={() => setDrawerOpen(false)} 
                     className="p-2 hover:bg-white/5 rounded-full text-gray-400 focus:text-white"
                   >
                     <X size={24} aria-hidden="true"/>
                   </button>
                </div>
                
                <div className="p-8 flex-1 overflow-y-auto space-y-8">
                   <div className="p-8 rounded-3xl bg-[#0f0f0f] border border-white/5 text-center relative overflow-hidden">
                      <div className="absolute top-0 right-0 w-32 h-32 bg-[#d4af37]/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                      <p className="text-gray-500 text-xs uppercase tracking-widest mb-2">Valor do Projeto</p>
                      <h3 className="text-5xl font-syne font-bold text-[#d4af37] mb-6">{formatCurrency(activeLead.value)}</h3>
                      
                      <div className="grid grid-cols-1 gap-3">
                        <button 
                          onClick={() => openWhatsApp(activeLead)}
                          className="w-full py-4 bg-[#25D366] text-black font-bold rounded-xl flex items-center justify-center gap-3 hover:scale-[1.02] transition-transform shadow-lg shadow-green-900/20"
                        >
                           <MessageCircle size={20} aria-hidden="true" /> Conversar no WhatsApp
                        </button>
                        
                        <button 
                          onClick={() => openCalendly(activeLead)}
                          className="w-full py-4 bg-[#1a1a1a] text-white border border-white/10 font-bold rounded-xl flex items-center justify-center gap-3 hover:bg-[#252525] transition-colors"
                        >
                           <CalendarDays size={20} aria-hidden="true" /> Marcar Reuni√£o Agora
                        </button>
                      </div>
                      <p className="mt-4 text-xs text-gray-500">Atalho: Pressione 'W' para Zap</p>
                   </div>
                   
                   <div>
                      <h4 className="text-sm font-bold text-white mb-3 uppercase tracking-wider text-gray-500">Briefing Inicial</h4>
                      <p className="text-gray-300 text-lg leading-relaxed font-light italic bg-[#0f0f0f] p-6 rounded-2xl border border-white/5">
                        "{activeLead.notes}"
                      </p>
                   </div>

                   <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 rounded-2xl bg-[#0f0f0f] border border-white/5">
                        <p className="text-gray-500 text-xs mb-1">Contato</p>
                        <p className="text-white font-mono text-sm">{activeLead.phone}</p>
                      </div>
                      <div className="p-4 rounded-2xl bg-[#0f0f0f] border border-white/5">
                        <p className="text-gray-500 text-xs mb-1">Data</p>
                        <p className="text-white font-mono text-sm">{new Date(activeLead.timestamp).toLocaleDateString()}</p>
                      </div>
                   </div>
                </div>
             </div>
           )}
        </div>
        
        {drawerOpen && (
          <div 
            className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[90]" 
            onClick={() => setDrawerOpen(false)}
            aria-hidden="true"
          ></div>
        )}

      </main>
    </div>
  );
};

export default AdminDashboard;